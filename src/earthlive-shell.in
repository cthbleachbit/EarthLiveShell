#!/bin/bash
#==========================================================
# EarthLiveShell
# Main Script
# Copyright (C) James Chai (cth451) <cth451@gmail.com>
# Inspired by bitdust's [ https://github.com/bitdust ]
# Licensed under LGPL 3
#
# This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the
# implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public
# License for more details.
#==========================================================

opt_store="${HOME}/.earthliveshell"
[[ -d ${opt_store} ]] || mkdir "${opt_store}"
[[ -f ${opt_store}/EarthLive.rc ]] || touch "${opt_store}/EarthLive.rc"

opt_interval=30
# default interval: 30 minutes
opt_density=1
# default image density: 1d

state_has_modified=0
[[ -f ${opt_store}/pid ]] && pid=$(cat ${opt_store}/pid) || pid=0
[[ -d /proc/$pid ]] && state_running=1 || state_running=0
. "${opt_store}/EarthLive.rc"

# Configuration save and restore
save_original () {
	opt_background_picture_options=$(gsettings get org.gnome.desktop.background picture-options)
	opt_background_picture_uri=$(gsettings get org.gnome.desktop.background picture-uri)
	
	[[ $opt_background_picture_uri == *"${opt_store}"* ]] && return 0
	[[ $opt_screensaver_picture_uri == *"${opt_store}"* ]] && return 0
	
	opt_background_primary_color=$(gsettings get org.gnome.desktop.background primary-color)
	opt_screensaver_picture_options=$(gsettings get org.gnome.desktop.screensaver picture-options)
	opt_screensaver_picture_uri=$(gsettings get org.gnome.desktop.screensaver picture-uri)
	opt_screensaver_primary_color=$(gsettings get org.gnome.desktop.screensaver primary-color)
	
	modify_opt "opt_background_picture_options"
	modify_opt "opt_background_picture_uri"
	modify_opt "opt_background_primary_color"
	modify_opt "opt_screensaver_picture_options"
	modify_opt "opt_screensaver_picture_uri"
	modify_opt "opt_screensaver_primary_color"
}

restore_original () {
	gsettings set org.gnome.desktop.background picture-options "$opt_background_picture_options"
	gsettings set org.gnome.desktop.background picture-uri "$opt_background_picture_uri"
	gsettings set org.gnome.desktop.background primary-color "$opt_background_primary_color"
	gsettings set org.gnome.desktop.screensaver picture-options "$opt_screensaver_picture_options"
	gsettings set org.gnome.desktop.screensaver picture-uri "$opt_screensaver_picture_uri"
	gsettings set org.gnome.desktop.screensaver primary-color "$opt_screensaver_primary_color"
}

# code reuse section
show_dialog () {
	zenity --class="EarthLive" --name="EarthLive" --title="EarthLive" "$@"
}


modify_opt () {
	sed -i "${opt_store}/EarthLive.rc" -e "/${1}=.*$/D"
	echo "${1}=${!1}" >> "${opt_store}/EarthLive.rc"
	state_has_modified=1
}

# Operational functions
flush_logs () {
	echo -n > ${opt_store}/EarthLive.log
}

start () {
	save_original
	setsid earthlive-daemon "$opt_interval" "$opt_density" &
	# picture-options 'none', 'wallpaper', 'centered', 'scaled', 'stretched', 'zoom', 'spanned'
	gsettings set org.gnome.desktop.background picture-options "'centered'"
	gsettings set org.gnome.desktop.background picture-uri "'file://${opt_store}/final.png'"
	gsettings set org.gnome.desktop.background primary-color black
	gsettings set org.gnome.desktop.screensaver picture-options "'centered'"
	gsettings set org.gnome.desktop.screensaver picture-uri "'file://${opt_store}/final.png'"
	gsettings set org.gnome.desktop.screensaver primary-color black
}

stop () {
	(( $state_running )) && kill -TERM $pid
	restore_original
}

toggle_autostart () {
	if [[ -f ${HOME}/.config/autostart/EarthLiveStart.desktop ]]; then
		rm -rf ${HOME}/.config/autostart/EarthLiveStart.desktop
		stop
		show_dialog --info --text="Won't autostart now."
	else
		[[ -d ${HOME}/.config/autostart ]] || mkdir -p ${HOME}/.config/autostart
		ln -sf /usr/local/share/applications/EarthLiveStart.desktop ${HOME}/.config/autostart/EarthLiveStart.desktop
		show_dialog --info --text="Autostart configured!"
	fi
}

options () {
	while [[ "${ans1}" = "" ]]; do
		ans=$(show_dialog --list --text="Choose an option." \
			--print-column=1 --height=200 --width=400 \
			--column "Parameter" --column "Description" \
			"opt_interval" "Interval between two image checks in minutes" \
			"opt_density" "Image Density.")
		[[ "$ans" = "" ]] && break
		if [[ "$ans" = "opt_interval" ]]; then
			ans1=$(show_dialog --entry \
				--text="${ans} is now ${!ans} minutes. Leave blank if you are not going to change it.")
			if [[ "$ans1" =~ ^[1-9][0-9]*$ ]]; then
				opt_interval="$ans1"
				modify_opt "opt_interval" "$ans1"
			else
				[[ "$ans1" = "" ]] || show_dialog \
					--error --text="What? This is a integer only field!"
			fi
			# ask for furthur options
			ans1=""
		elif [[ "$ans" = "opt_density" ]]; then
			ans1=$(show_dialog --entry \
				--text="${ans:4} is now ${!ans}. Leave blank if you are not going to change it.")
			if [[ "$ans1" =~ ^(1|2|4)$ ]]; then
				opt_density="$ans1"
				modify_opt "opt_density" "$ans1"
			else
				[[ "$ans1" = "" ]] || show_dialog \
					--error --text="Density must be one of 1, 2 and 4. To set it higher to 8, 10, 16 and 20, edit ~/.earthliveshell/EarthLive.rc"
			fi
			# ask for furthur options
			ans1=""
		fi
	done
	
	# if running previously, restart
	if (( $state_has_modified & $state_running )); then
		stop
		start
	fi
}

# Main
if [[ "$1" == "--start" ]]; then
	(( state_running )) || start
else
	if (( state_running )); then
		MAJOR=$(show_dialog \
			--list --text="EarthLive Service is <b>running</b>." --height=230 --width=300 \
			--column "Ops" "Stop" "Options" "Toggle Autostart" "Flush Logs")
	else
		MAJOR=$(show_dialog \
			--list --text="EarthLive Service is <b>not running</b>." --height=230 --width=300 \
			--column "Ops" "Start" "Options" "Toggle Autostart" "Flush Logs")
	fi
	
	case "$MAJOR" in
		"Start")		start;;
		"Stop")			stop;;
		"Options")		options;;
		"Toggle Autostart")	toggle_autostart;;
		"Flush Logs")		flush_logs;;
	esac
fi
