#!/bin/bash
#==========================================================
# EarthLiveShell
# Main Script
# Copyright (C) James Chai (cth451) <cth451@gmail.com>
# Inspired by bitdust's [ https://github.com/bitdust ]
# Licensed under LGPL 3
#
# This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the
# implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public
# License for more details.
#==========================================================

opt_store="${HOME}/.earthliveshell"
[[ -d ${opt_store} ]] || mkdir "${opt_store}"
[[ -f ${opt_store}/EarthLive.rc ]] || touch "${opt_store}/EarthLive.rc"
opt_interval=30
state_has_modified=0

pid=`cat ${opt_store}/pid`
[[ -d /proc/$pid ]] && state_running=1 || state_running=0
. "${opt_store}/EarthLive.rc"

start () {
	opt_original_desktop=`gsettings get org.gnome.desktop.background picture-uri`
	opt_original_screensaver=`gsettings get org.gnome.desktop.screensaver picture-uri`
	[[ $opt_original_desktop == *"${opt_store}"* ]] || modify_opt "opt_original_desktop" "$opt_original_desktop"
	[[ $opt_original_desktop == *"${opt_store}"* ]] || modify_opt "opt_original_screensaver" "$opt_original_screensaver"
	res_x=`xdpyinfo | awk -F'[ x]+' '/dimensions:/{print $3}'`
	res_y=`xdpyinfo | awk -F'[ x]+' '/dimensions:/{print $4}'`
	setsid earthlive-daemon "$opt_interval" "$res_x" "$res_y" &
	gsettings set org.gnome.desktop.background picture-uri "'file://${opt_store}/final.jpg'"
	gsettings set org.gnome.desktop.screensaver picture-uri "'file://${opt_store}/final.jpg'"
}

stop () {
	(( $state_running )) && kill -TERM $pid
	gsettings set org.gnome.desktop.background picture-uri "$opt_original_desktop"
	gsettings set org.gnome.desktop.screensaver picture-uri "$opt_original_screensaver"
}

modify_opt () {
	sed -i "${opt_store}/EarthLive.rc" -e "/${1}=.*$/D"
	echo "${1}=${2}" >> "${opt_store}/EarthLive.rc"
	state_has_modified=1
}

options () {
	while [[ "${ans1}" = "" ]]; do
		ans=`zenity --class=EarthLive --name=EarthLive \
			--list --text="Choose an option." \
			--title="EarthLive" --print-column=1 \
			--column "Name" --column "Description" \
			"opt_interval" "Interval between two image checks"`
		[[ "$ans" = "" ]] && break
		ans1=`zenity --class=EarthLive --name=EarthLive --entry \
			--text="${ans:4} is now ${!ans} minutes. Leave blank if you are not going to change it."`
		if [[ "$ans" = "opt_interval" ]]; then
			if [[ "$ans1" =~ ^[1-9][0-9]*$ ]]; then
				opt_interval="$ans1"
				modify_opt "opt_interval" "$ans1"
			else
				[[ "$ans1" = "" ]] || zenity --class=EarthLive --name=EarthLive \
					--title="EarthLive" --error --text="What? This is a numeric field!"
			fi
			# ask for furthur options
			ans1=""
		fi
	done
	
	# if running previously, restart
	if (( $state_has_modified & $state_running )); then
		stop
		start
	fi
}

if [[ "$1" = "--interactive" ]]; then
	if (( $state_running )); then
		MAJOR=`zenity --class=EarthLive --name=EarthLive \
			--list --text="EarthLive Service is <b>running</b>." \
			--title="EarthLive" --column "Ops" "Stop" "Options"`
	else
		MAJOR=`zenity --class=EarthLive --name=EarthLive \
			--list --text="EarthLive Service is <b>not running</b>." \
			--title="EarthLive" --column "Ops" "Start" "Options"`
	fi
	
	case "$MAJOR" in
		"Start")	start;;
		"Stop")		stop;;
		"Options")	options;;
	esac
else
	start
fi
