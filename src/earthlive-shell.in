#!/bin/bash
#==========================================================
# EarthLiveShell
# Main Script
# Copyright (C) James Chai (cth451) <cth451@gmail.com>
# Inspired by bitdust's [ https://github.com/bitdust ]
# Licensed under LGPL 3
#
# This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the
# implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public
# License for more details.
#==========================================================

opt_store="${HOME}/.earthliveshell"
[[ -d ${opt_store} ]] || mkdir "${opt_store}"
[[ -f ${opt_store}/EarthLive.rc ]] || touch "${opt_store}/EarthLive.rc"
opt_interval=30
state_has_modified=0

pid=`cat ${opt_store}/pid`
[[ -d /proc/$pid ]] && state_running=1 || state_running=0
. "${opt_store}/EarthLive.rc"

save_original () {
	opt_background_picture_options=$(gsettings get org.gnome.desktop.background picture-options)
	opt_background_picture_uri=$(gsettings get org.gnome.desktop.background picture-uri)
	opt_screensaver_picture_options=$(gsettings get org.gnome.desktop.screensaver picture-options)
	opt_screensaver_picture_uri=$(gsettings get org.gnome.desktop.screensaver picture-uri)
	
	[[ $opt_background_picture_uri == *"${opt_store}"* ]] && return 0
	[[ $opt_screensaver_picture_uri == *"${opt_store}"* ]] && return 0
	
	modify_opt "opt_background_picture_options"
	modify_opt "opt_background_picture_uri"
	modify_opt "opt_screensaver_picture_options"
	modify_opt "opt_screensaver_picture_uri"
}

restore_original () {
	gsettings set org.gnome.desktop.background picture-options "$opt_background_picture_options"
	gsettings set org.gnome.desktop.background picture-uri "$opt_background_picture_uri"
	gsettings set org.gnome.desktop.screensaver picture-options "$opt_screensaver_picture_options"
	gsettings set org.gnome.desktop.screensaver picture-uri "$opt_screensaver_picture_uri"
}

start () {
	save_original
	setsid earthlive-daemon "$opt_interval" &
	# picture-options 'none', 'wallpaper', 'centered', 'scaled', 'stretched', 'zoom', 'spanned'
	gsettings set org.gnome.desktop.background picture-options "'centered'"
	gsettings set org.gnome.desktop.background picture-uri "'file://${opt_store}/final.png'"
	gsettings set org.gnome.desktop.screensaver picture-options "'centered'"
	gsettings set org.gnome.desktop.screensaver picture-uri "'file://${opt_store}/final.png'"
}

stop () {
	(( $state_running )) && kill -TERM $pid
	restore_original
}

toggle_autostart () {
	if [[ -f ${HOME}/.config/autostart/EarthLiveStart.desktop ]]; then
		rm -rf ${HOME}/.config/autostart/EarthLiveStart.desktop
		stop
		show_dialog --info --text="Won't autostart now."
	else
		ln -sf /usr/local/share/applications/EarthLiveStart.desktop ${HOME}/.config/autostart/EarthLiveStart.desktop
		show_dialog --info --text="Autostart configured!"
	fi
}

modify_opt () {
	sed -i "${opt_store}/EarthLive.rc" -e "/${1}=.*$/D"
	echo "${1}=${!1}" >> "${opt_store}/EarthLive.rc"
	state_has_modified=1
}

show_dialog () {
	zenity --class="EarthLive" --name="EarthLive" --title="EarthLive" "$@"
}

options () {
	while [[ "${ans1}" = "" ]]; do
		ans=$(show_dialog --list --text="Choose an option." \
			--print-column=1 \
			--column "Name" --column "Description" \
			"opt_interval" "Interval between two image checks")
		[[ "$ans" = "" ]] && break
		ans1=$(show_dialog --entry \
			--text="${ans:4} is now ${!ans} minutes. Leave blank if you are not going to change it.")
		if [[ "$ans" = "opt_interval" ]]; then
			if [[ "$ans1" =~ ^[1-9][0-9]*$ ]]; then
				opt_interval="$ans1"
				modify_opt "opt_interval" "$ans1"
			else
				[[ "$ans1" = "" ]] || show_dialog \
					--error --text="What? This is a numeric field!"
			fi
			# ask for furthur options
			ans1=""
		fi
	done
	
	# if running previously, restart
	if (( $state_has_modified & $state_running )); then
		stop
		start
	fi
}

if [[ "$1" == "--start" ]]; then
	start
else
	if (( $state_running )); then
		MAJOR=$(show_dialog \
			--list --text="EarthLive Service is <b>running</b>." \
			--column "Ops" "Stop" "Options" "Toggle Autostart")
	else
		MAJOR=$(show_dialog \
			--list --text="EarthLive Service is <b>not running</b>." \
			--column "Ops" "Start" "Options" "Toggle Autostart")
	fi
	
	case "$MAJOR" in
		"Start")		start;;
		"Stop")			stop;;
		"Options")		options;;
		"Toggle Autostart")	toggle_autostart;;
	esac
fi
